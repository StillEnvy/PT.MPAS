<!DOCTYPE html>
<html>
<head>
  <title>Geofencing Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

  <style>
    #map {
      height: 500px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    const map = L.map('map').setView([-6.158265831232071, 106.89338157484296], 15);

    // Tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // ----------------------------------------------------------
    // 2) Static device location (your original)
    // ----------------------------------------------------------
    const deviceLocation = [-6.158172125383277, 106.89342900891994]; // [lat, lng]
    const deviceMarker = L.marker(deviceLocation).addTo(map)
      .bindPopup("Device Location").openPopup();

    const devicePoint = turf.point([deviceLocation[1], deviceLocation[0]]); // [lng, lat]

    // ----------------------------------------------------------
    // 3) Static polygon geofence (your original)
    // ----------------------------------------------------------
    const geofenceCoords = [
      [-6.158081454512796, 106.8933377683183],
      [-6.159905495961529, 106.8922863424369],
      [-6.1604868411881775, 106.89318756462097],
      [-6.158406795698174, 106.89413170214715]
    ];

    const geofencePolygon = L.polygon(geofenceCoords, {
      color: "blue",
      fillOpacity: 0.1
    }).addTo(map);

    const polygonGeoJSON = turf.polygon([[
      ...geofenceCoords.map(c => [c[1], c[0]]),
      [geofenceCoords[0][1], geofenceCoords[0][0]] // close polygon
    ]]);

    // Initial check for static polygon
    if (!turf.booleanPointInPolygon(devicePoint, polygonGeoJSON)) {
      alert("Device is OUTSIDE the static geofence!");
    } else {
      console.log("Device is inside the static geofence.");
    }

    // ----------------------------------------------------------
    // 4) INTERACTIVE GEOFENCING
    // ----------------------------------------------------------
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    // Enable drawing tools
    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: {
        polygon: true,
        rectangle: true,
        circle: true,
        marker: false,
        polyline: false
      }
    });
    map.addControl(drawControl);

    // When user draws a shape
    map.on(L.Draw.Event.CREATED, function (e) {
      drawnItems.clearLayers(); // keep only 1 shape
      const layer = e.layer;
      drawnItems.addLayer(layer);

      // Convert the shape to GeoJSON
      const geojson = layer.toGeoJSON();

      // ----------------------------------------------------------
      // CHECK FOR POLYGON / RECTANGLE
      // ----------------------------------------------------------
      if (geojson.geometry.type === "Polygon") {
        const turfPolygon = geojson;

        const inside = turf.booleanPointInPolygon(devicePoint, turfPolygon);

        if (inside) {
          alert("Device is INSIDE the drawn geofence!");
        } else {
          alert("Device is OUTSIDE the drawn geofence!");
        }
      }

      // ----------------------------------------------------------
      // CHECK FOR CIRCLE GEOFENCE
      // ----------------------------------------------------------
      if (geojson.geometry.type === "Point" && layer.getRadius) {
        const center = geojson.geometry.coordinates; // [lng, lat]
        const radius = layer.getRadius(); // meters

        const distance = turf.distance(devicePoint, center, { units: "meters" });

        if (distance <= radius) {
          alert("Device is INSIDE the circle geofence!");
        } else {
          alert("Device is OUTSIDE the circle geofence!");
        }
      }
    });
  </script>
</body>
</html>